From 49c13d7fca510ee5e1950fbb41a29772f3475b8e Mon Sep 17 00:00:00 2001
From: Daniel Nicoletti <dantt12@gmail.com>
Date: Wed, 23 May 2012 12:13:39 -0300
Subject: [PATCH] aptcc: save the changelog to a random directory

---
 backends/aptcc/apt-intf.cpp  |   10 +++++++++-
 backends/aptcc/apt-utils.cpp |   18 +++++++-----------
 backends/aptcc/apt-utils.h   |   13 +++++++------
 3 files changed, 23 insertions(+), 18 deletions(-)

diff --git a/backends/aptcc/apt-intf.cpp b/backends/aptcc/apt-intf.cpp
index edd4589..f9c959c 100644
--- a/backends/aptcc/apt-intf.cpp
+++ b/backends/aptcc/apt-intf.cpp
@@ -783,7 +783,14 @@ void AptIntf::emitUpdateDetail(const pkgCache::VerIterator &candver)
 
     // fetch the changelog
     pk_backend_set_status(m_backend, PK_STATUS_ENUM_DOWNLOAD_CHANGELOG);
-    string filename = getChangelogFile(pkg.Name(), origin, verstr, srcpkg, uri, &fetcher);
+    
+    // Create a random temp dir
+    char dirName[] = "/tmp/aptccXXXXXXXX";
+    char *tempDir = mkdtemp(dirName);
+    string filename = tempDir;
+    filename.append("/");
+    filename.append(pkg.Name());
+    getChangelogFile(filename, pkg.Name(), origin, verstr, srcpkg, uri, &fetcher);
 
     string changelog;
     string update_text;
@@ -866,6 +873,7 @@ void AptIntf::emitUpdateDetail(const pkgCache::VerIterator &candver)
     g_regex_unref(regexVer);
     g_regex_unref(regexDate);
     unlink(filename.c_str());
+    rmdir(tempDir);
 
     // Check if the update was updates since it was issued
     if (issued.compare(updated) == 0) {
diff --git a/backends/aptcc/apt-utils.cpp b/backends/aptcc/apt-utils.cpp
index 9d22a19..f4ff09c 100644
--- a/backends/aptcc/apt-utils.cpp
+++ b/backends/aptcc/apt-utils.cpp
@@ -107,19 +107,17 @@ PkGroupEnum get_enum_group(string group)
     }
 }
 
-string getChangelogFile(const string &name,
-                        const string &origin,
-                        const string &verstr,
-                        const string &srcPkg,
-                        const string &uri,
-                        pkgAcquire *fetcher)
+void getChangelogFile(const string &filename,
+                      const string &name,
+                      const string &origin,
+                      const string &verstr,
+                      const string &srcPkg,
+                      const string &uri,
+                      pkgAcquire *fetcher)
 {
     string descr("Changelog for ");
     descr += name;
 
-    // no need to translate this, the changelog is in english anyway
-    string filename = "/tmp/aptcc_changelog";
-
     new pkgAcqFileSane(fetcher, uri, descr, name, filename);
 
     ofstream out(filename.c_str());
@@ -146,8 +144,6 @@ string getChangelogFile(const string &name,
         }
     }
     out.close();
-
-    return filename;
 }
 
 string getCVEUrls(const string &changelog)
diff --git a/backends/aptcc/apt-utils.h b/backends/aptcc/apt-utils.h
index 0102fde..bd53498 100644
--- a/backends/aptcc/apt-utils.h
+++ b/backends/aptcc/apt-utils.h
@@ -39,12 +39,13 @@ PkGroupEnum get_enum_group(string group);
 /**
   * Return the changelog filename fetched
   */
-string getChangelogFile(const string &name,
-                        const string &origin,
-                        const string &verstr,
-                        const string &srcPkg,
-                        const string &uri,
-                        pkgAcquire *fetcher);
+void getChangelogFile(const string &filename,
+                      const string &name,
+                      const string &origin,
+                      const string &verstr,
+                      const string &srcPkg,
+                      const string &uri,
+                      pkgAcquire *fetcher);
 
 /**
   * Returns a list of links pairs url;description for CVEs
-- 
1.7.10

